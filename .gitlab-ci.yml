stages:
  - build
  - deploy

variables:
  SSH_USER: "ubuntu"
  SERVER_IP: "52.91.55.250"
  DEPLOY_PATH: "/srv/borsibaar"
  DOCKER_COMPOSE_FILE: "docker-compose.prod.yaml"

before_script:
  - "which ssh-agent || apk add --no-cache openssh-client"
  - eval $(ssh-agent -s)
  - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null
  - mkdir -p ~/.ssh
  - chmod 700 ~/.ssh
  - ssh-keyscan $SERVER_IP >> ~/.ssh/known_hosts

build-backend:
  stage: build
  image: maven:3.9-eclipse-temurin-21
  script:
    - cd backend
    - ./mvnw clean package -DskipTests
  artifacts:
    paths:
      - backend/target/*.jar
    expire_in: 1 hour
  only:
    - main

build-frontend:
  stage: build
  image: node:20-alpine
  script:
    - cd frontend
    - npm ci
    - npm run build
  artifacts:
    paths:
      - frontend/out/
    expire_in: 1 hour
  only:
    - main

deploy-job:
  stage: deploy
  image: alpine:latest
  needs:
    - build-backend
    - build-frontend
  script:
    - echo "Starting deployment..."

    # Install required tools
    - apk add --no-cache tar

    # Create env file from GitLab variable (FIXED)
    - echo "$ENV_PRODUCTION_FILE" > .env.production

    # Create deployment package
    - tar czf deployment.tar.gz backend/target/*.jar frontend/ nginx/ docker-compose.prod.yaml backend/Dockerfile frontend/Dockerfile .env.production

    # Copy to server
    - scp deployment.tar.gz $SSH_USER@$SERVER_IP:/tmp/

    # Deploy on server
    - |
      ssh $SSH_USER@$SERVER_IP << EOF
      set -e

      mkdir -p $DEPLOY_PATH
      cd $DEPLOY_PATH

      # Clean old files
      rm -rf *

      # Extract deployment package
      tar xzf /tmp/deployment.tar.gz
      rm /tmp/deployment.tar.gz

      # Copy environment file if exists
      if [ -f .env.production ]; then
        cp .env.production .env
      fi

      # Restart docker to avoid cache issues
      sudo systemctl restart docker || true

      # Stop existing containers
      docker-compose -f $DOCKER_COMPOSE_FILE down || true

      # Rebuild and start containers
      docker-compose -f $DOCKER_COMPOSE_FILE build
      docker-compose -f $DOCKER_COMPOSE_FILE up -d

      # Clean up old images
      docker image prune -f

      echo "Deployment complete!"
      docker-compose -f $DOCKER_COMPOSE_FILE ps
      EOF

  environment:
    name: production
    url: http://$SERVER_IP
  only:
    - main
