name: Build and Deploy

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      SERVER_IP: ${{ secrets.SERVER_IP }}
      DEPLOY_PATH: /srv/borsibaar
      ENV_PRODUCTION_FILE: ${{ secrets.ENV_PRODUCTION_FILE }}
      DOCKER_COMPOSE_FILE: docker-compose.prod.yaml

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Build backend
        working-directory: backend
        run: ./mvnw clean package -DskipTests

      - name: Set up Node 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan "$SERVER_IP" >> ~/.ssh/known_hosts

      - name: Create .env.production from secret
        run: |
          printf '%s\n' "$ENV_PRODUCTION_FILE" > .env.production

      - name: Create deployment package
        run: |
          tar czf deployment.tar.gz \
            backend/target/*.jar \
            frontend/ \
            nginx/ \
            "$DOCKER_COMPOSE_FILE" \
            backend/Dockerfile \
            frontend/Dockerfile \
            .env.production

      - name: Copy deployment package to server
        run: |
          scp -i ~/.ssh/id_rsa \
            -o StrictHostKeyChecking=yes \
            deployment.tar.gz \
            "$SSH_USER@$SERVER_IP:/tmp/"

      - name: Deploy on server
        run: |
          ssh -i ~/.ssh/id_rsa \
            -o StrictHostKeyChecking=yes \
            "$SSH_USER@$SERVER_IP" << EOF
          set -e

          mkdir -p $DEPLOY_PATH
          cd $DEPLOY_PATH

          # Clean old files
          rm -rf *

          # Extract deployment package
          tar xzf /tmp/deployment.tar.gz
          rm /tmp/deployment.tar.gz

          # Copy environment file if exists
          if [ -f .env.production ]; then
            cp .env.production .env
          fi

          # Stop existing containers
          docker compose -f "$DOCKER_COMPOSE_FILE" down

          # Build and start containers
          docker compose -f "$DOCKER_COMPOSE_FILE" build
          docker compose -f "$DOCKER_COMPOSE_FILE" up -d

          # Cleanup old images
          docker image prune -f

          echo "Deployment complete!"
          docker compose -f "$DOCKER_COMPOSE_FILE" ps
          EOF
